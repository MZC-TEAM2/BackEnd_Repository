# 프로젝트 요구사항 명세

예약 관리 서비스 (Reservation Manager Service)의 전체 요구사항을 정의합니다.

---

## 목차

- [프로젝트 개요](#프로젝트-개요)
- [비즈니스 요구사항](#비즈니스-요구사항)
- [기능 요구사항](#기능-요구사항)
- [비기능 요구사항](#비기능-요구사항)
- [제약사항](#제약사항)
- [가정사항](#가정사항)
- [우선순위](#우선순위)

---

## 프로젝트 개요

### 배경

공간 예약 시스템의 MSA(Microservices Architecture) 환경에서 예약 정보는 여러 서비스에 분산되어 있습니다:

- **예약 서비스**: 예약 생성, 슬롯 관리
- **결제 서비스**: 결제 처리, 환불
- **가격 서비스**: 가격 계산, 상품 관리
- **쿠폰 서비스**: 쿠폰 검증, 할인 계산

이로 인해 다음과 같은 문제가 발생합니다:
- 예약 조회 시 여러 서비스 호출 필요 (성능 저하)
- 가격/상품 정책 변경 시 과거 예약 데이터 불일치
- 블랙리스트 관리 주체 불명확
- 예약 데이터 분석 어려움

### 목적

예약 정보를 통합 관리하고 분석하는 독립 서비스를 구축하여:
- 예약 조회를 단일 서비스에서 완결
- 예약 시점의 데이터를 불변 스냅샷으로 보존
- 블랙리스트 기반 자동 거절 제공
- 예약 데이터 분석 및 통계 제공

### 범위

**포함 (In Scope):**
- 예약 정보 스냅샷 저장 및 조회
- 블랙리스트 관리 및 자동 거절
- 예약 데이터 분석 (일/월별 현황, 예약률/공실률)
- 사용자별/공간별 예약 통계

**제외 (Out of Scope):**
- 예약 생성 로직 (예약 서비스 책임)
- 결제 처리 (결제 서비스 책임)
- 가격 계산 (가격 서비스 책임)
- 쿠폰 생성/관리 (쿠폰 서비스 책임)

---

## 비즈니스 요구사항

### BR-001: 예약 정보 통합 관리

**요구사항:**
예약 서버로부터 받은 예약 정보를 스냅샷으로 저장하여, 외부 서비스 조회 없이 완결된 예약 데이터를 제공해야 합니다.

**비즈니스 가치:**
- 조회 성능 향상 (외부 서비스 호출 불필요)
- 데이터 무결성 보장 (정책 변경에 영향받지 않음)
- 분쟁 해결 용이 (예약 시점의 정확한 정보 보존)

**성공 기준:**
- 예약 조회 시 외부 서비스 호출 0회
- 상품 가격 변경 후에도 기존 예약은 이전 가격 유지
- 예약 상세 정보 조회 API 응답 시간 < 200ms

---

### BR-002: 블랙리스트 자동 거절

**요구사항:**
공간 운영자가 등록한 블랙리스트 사용자의 예약을 결제 완료 후 자동으로 거절해야 합니다.

**비즈니스 가치:**
- 악의적 사용자 차단 자동화
- 공간 운영자 업무 부담 감소
- 노쇼 등 문제 사용자 재발 방지

**성공 기준:**
- 블랙리스트 사용자 예약 시 100% 자동 거절
- 거절 후 환불 이벤트 발행
- 거절 처리 시간 < 500ms

**비즈니스 시나리오:**
```
1. 사용자 A가 과거 노쇼 3회 발생
2. 공간 운영자가 사용자 A를 블랙리스트 등록
3. 사용자 A가 재예약 시도
4. 결제 완료 후 시스템이 자동 거절
5. 환불 프로세스 자동 시작
6. 사용자 A에게 거절 사유 통지
```

---

### BR-003: 예약 데이터 분석

**요구사항:**
예약 데이터를 집계하여 공간 운영자와 관리자에게 의사결정에 필요한 통계를 제공해야 합니다.

**비즈니스 가치:**
- 운영 효율성 분석 (예약률/공실률)
- 수익 최적화 (인기 시간대 파악)
- 마케팅 전략 수립 (사용자 패턴 분석)

**성공 기준:**
- 일/월별 예약 현황 제공
- 예약률/공실률 계산
- 사용자별 예약 횟수 제공
- 통계 API 응답 시간 < 1초

---

## 기능 요구사항

### 1. 예약 관리

#### FR-001: 예약 정보 수신 및 저장

**기능 설명:**
예약 서버로부터 Kafka 이벤트를 수신하여 예약 정보를 저장합니다.

**입력:**
- ReservationCreatedEvent (Kafka)
  - reservationId
  - bookerId, placeId, roomId
  - reservationDate, startTimes
  - products (id, name, quantity, unitPrice)
  - totalPrice

**처리:**
1. 이벤트 수신
2. 쿠폰 서비스 동기 호출 (쿠폰 검증)
3. ReservationEntity 생성 (PENDING 상태)
4. 스냅샷 저장 (상품, 쿠폰, 시간 정보)

**출력:**
- 예약 정보 DB 저장

**제약사항:**
- 중복 이벤트 처리: 동일 reservationId 재수신 시 무시
- 쿠폰 검증 실패 시: 쿠폰 없이 저장 (쿠폰 정보 null)

---

#### FR-002: 예약 확정

**기능 설명:**
결제 완료 이벤트 수신 시 예약 상태를 업데이트하고 블랙리스트를 체크합니다.

**입력:**
- PaymentCompletedEvent (Kafka)
  - reservationId
  - bookerId, placeId

**처리:**
1. 예약 상태 PENDING → PAID
2. 블랙리스트 체크 (placeId + bookerId)
3. 블랙리스트인 경우:
   - 상태 PAID → REJECTED
   - ReservationRejectedEvent 발행 (환불 트리거)
4. 블랙리스트 아닌 경우:
   - 상태 PAID → CONFIRMED

**출력:**
- 예약 상태 업데이트
- 거절 이벤트 발행 (조건부)

---

#### FR-003: 예약 상세 조회

**기능 설명:**
예약 ID로 예약 상세 정보를 조회합니다.

**입력:**
- reservationId (Path Parameter)

**출력:**
```json
{
  "reservationId": 123456,
  "bookerId": 1001,
  "bookerReservationCount": 15,
  "placeId": 100,
  "roomId": 10,
  "status": "CONFIRMED",
  "totalPrice": 72000,
  "timeInfo": {
    "reservationDate": "2025-01-15",
    "startTimes": ["11:00", "12:00", "13:00"]
  },
  "products": [...],
  "coupons": [...],
  "additionalInfos": [...],
  "createdAt": "2025-01-15T10:30:00",
  "acceptedAt": "2025-01-15T11:00:00"
}
```

**특이사항:**
- `bookerReservationCount`: 해당 사용자의 총 예약 횟수 (실시간 집계)

---

#### FR-004: 예약 목록 조회

**기능 설명:**
사용자별 또는 공간별 예약 목록을 조회합니다.

**입력:**
- userId (Path Parameter) 또는 placeId + roomId
- 페이징 파라미터 (page, size)
- 필터 (status, dateFrom, dateTo)

**출력:**
- 예약 목록 (페이징)
- 각 예약의 요약 정보

---

#### FR-005: 추가 정보 업데이트

**기능 설명:**
공간 운영자가 설정한 커스텀 필드에 사용자가 값을 입력합니다.

**입력:**
- reservationId (Path Parameter)
- additionalInfos (Request Body)
  ```json
  [
    { "infoName": "방문 목적", "infoContent": "스터디 모임" },
    { "infoName": "요청사항", "infoContent": "조용한 공간 희망" }
  ]
  ```

**처리:**
- 기존 추가 정보 덮어쓰기
- 예약 상태 PENDING일 때만 허용

**출력:**
- 업데이트된 예약 정보

---

### 2. 블랙리스트 관리

#### FR-006: 블랙리스트 등록

**기능 설명:**
공간 운영자가 특정 사용자를 블랙리스트에 등록합니다.

**입력:**
- placeId (Request Body)
- userId (Request Body)
- reason (Request Body) - 최소 5자 이상
- expiredAt (Request Body) - nullable (null = 영구 차단)
- registeredBy (Header) - Gateway에서 전달된 운영자 ID

**처리:**
1. 이미 등록된 경우: 에러 반환
2. BlackListEntity 생성
3. DB 저장

**출력:**
- 블랙리스트 등록 완료

---

#### FR-007: 블랙리스트 조회

**기능 설명:**
특정 공간의 블랙리스트 목록을 조회합니다.

**입력:**
- placeId (Path Parameter)
- 페이징 파라미터 (page, size)

**출력:**
- 블랙리스트 목록
  - userId, reason, registeredBy, createdAt, expiredAt
  - 만료 여부 (isExpired)

---

#### FR-008: 블랙리스트 해제

**기능 설명:**
블랙리스트에서 특정 사용자를 해제합니다.

**입력:**
- placeId (Path Parameter)
- userId (Path Parameter)
- registeredBy (Header) - 운영자 ID

**처리:**
- 등록자와 해제 요청자가 동일한지 검증 (선택사항)
- 블랙리스트 삭제

**출력:**
- 해제 완료

---

### 3. 통계 및 분석

#### FR-009: 일별 예약 현황

**기능 설명:**
특정 기간 동안 일별 예약 건수와 상태별 분포를 제공합니다.

**입력:**
- placeId (Query Parameter)
- startDate, endDate (Query Parameter)

**출력:**
```json
{
  "statistics": [
    {
      "date": "2025-01-15",
      "totalReservations": 25,
      "confirmedReservations": 20,
      "rejectedReservations": 3,
      "refundedReservations": 2
    }
  ]
}
```

---

#### FR-010: 월별 예약 현황

**기능 설명:**
월별 예약 추이를 제공합니다.

**입력:**
- placeId (Query Parameter)
- year, month (Query Parameter)

**출력:**
- 월별 예약 건수 및 상태별 분포

---

#### FR-011: 예약률 및 공실률

**기능 설명:**
특정 기간 동안 예약률과 공실률을 계산합니다.

**입력:**
- placeId, roomId (Query Parameter)
- startDate, endDate (Query Parameter)
- timeSlotUnit (Query Parameter) - 30 또는 60 (분 단위)

**계산 로직:**
```
예약률 = (예약된 시간 블록 수 / 전체 가용 시간 블록 수) × 100
공실률 = 100 - 예약률

전체 가용 시간 블록 수 = 시간 관리 서버 조회
```

**출력:**
```json
{
  "occupancyRate": 69.2,
  "vacancyRate": 30.8,
  "totalSlots": 13,
  "reservedSlots": 9
}
```

---

## 비기능 요구사항

### NFR-001: 성능

| 항목 | 목표 | 측정 방법 |
|------|------|-----------|
| API 응답 시간 (조회) | < 200ms | P95 |
| API 응답 시간 (통계) | < 1초 | P95 |
| 이벤트 처리 시간 | < 500ms | 평균 |
| 동시 사용자 | 1,000명 | 부하 테스트 |

**성능 최적화 전략:**
- 인덱싱: bookerId, placeId, status, date
- 쿼리 최적화: N+1 문제 방지
- 통계 캐싱 (향후): Redis

---

### NFR-002: 가용성

| 항목 | 목표 |
|------|------|
| Uptime | 99.9% |
| RTO (Recovery Time Objective) | < 10분 |
| RPO (Recovery Point Objective) | < 5분 |

**고가용성 확보 방안:**
- 서비스 이중화 (최소 2개 인스턴스)
- DB 복제 (Master-Slave)
- Health Check 엔드포인트 제공

---

### NFR-003: 확장성

**수평 확장 (Scale Out):**
- Stateless 설계
- Kafka Consumer Group 활용
- 세션 정보 외부 저장 (Redis - 향후)

**수직 확장 (Scale Up):**
- 초기 버전에서 허용
- 장기적으로 수평 확장 우선

**통계 서버 분리 가능:**
- Port/Adapter 패턴으로 경계 명확
- Kafka 이벤트 구독으로 데이터 동기화

---

### NFR-004: 보안

| 항목 | 요구사항 |
|------|----------|
| 인증 | Gateway에서 처리 (JWT) |
| 인가 | 공간 운영자 권한 검증 (블랙리스트 등록/해제) |
| 데이터 암호화 | TLS 1.3 (전송 중) |
| 개인정보 보호 | 최소 수집 원칙 |

**보안 고려사항:**
- SQL Injection 방지 (Prepared Statement)
- XSS 방지 (입력 검증)
- CSRF 방지 (Spring Security)

---

### NFR-005: 유지보수성

**코드 품질:**
- Google Java Style Guide 준수
- SonarQube 정적 분석 (향후)
- 테스트 커버리지 > 70%

**문서화:**
- API 문서: Swagger/OpenAPI (향후)
- 아키텍처 결정 문서 (ADR)
- 코드 주석: Javadoc

**모니터링:**
- 로깅: SLF4J + Logback
- 메트릭: Actuator (향후)
- 분산 추적: Zipkin (향후)

---

### NFR-006: 호환성

| 항목 | 요구사항 |
|------|----------|
| JDK | 17 LTS |
| Spring Boot | 3.5.x |
| PostgreSQL | 16.x |
| Kafka | 3.6.x |

**하위 호환성:**
- API 버전 관리 (/v1/)
- DB 마이그레이션: Flyway

---

## 제약사항

### 기술적 제약

1. **예약 ID 생성 권한 없음**
   - 예약 서버에서 생성한 ID 사용
   - 이 서비스는 ID 생성 불가

2. **쿠폰 정합성 검증 의존**
   - 쿠폰 서비스 API 호출 필수
   - 쿠폰 서비스 장애 시 쿠폰 없이 저장

3. **시간 관리 서버 의존**
   - 공실률 계산 시 전체 슬롯 정보 조회 필요
   - 시간 관리 서버 장애 시 공실률 계산 불가

4. **인증/인가 책임 없음**
   - Gateway에서 처리
   - 이 서비스는 전달된 사용자 정보 신뢰

### 비즈니스 제약

1. **블랙리스트 등록 권한**
   - 공간 운영자만 가능
   - 일반 사용자는 불가

2. **예약 생성 불가**
   - 예약 서버의 책임
   - 이 서비스는 조회/분석만

3. **결제 처리 불가**
   - 결제 서비스의 책임
   - 이 서비스는 상태 업데이트만

---

## 가정사항

### AS-001: 이벤트 순서 보장

**가정:**
Kafka 이벤트가 순서대로 전달된다고 가정합니다.

**영향:**
- ReservationCreated → PaymentCompleted 순서 보장
- 순서가 뒤바뀌면 PaymentCompleted 이벤트 처리 실패 가능

**대응:**
- 이벤트 재처리 로직 (Retry)
- 순서 검증 로직 (향후)

---

### AS-002: 예약 서버 데이터 정확성

**가정:**
예약 서버로부터 받은 데이터가 정확하고 완전하다고 가정합니다.

**영향:**
- 가격, 상품 정보 검증 생략
- 예약 서버 버그 시 잘못된 데이터 저장 가능

**대응:**
- 기본 검증만 수행 (null 체크, 범위 체크)
- 예약 서버 신뢰

---

### AS-003: 쿠폰 서비스 가용성

**가정:**
쿠폰 서비스가 대부분의 경우 정상 동작한다고 가정합니다.

**영향:**
- 쿠폰 서비스 장애 시 쿠폰 검증 실패
- 쿠폰 없이 예약 저장 (사용자 경험 저하)

**대응:**
- Timeout 설정 (3초)
- Fallback: 쿠폰 정보 null로 저장

---

### AS-004: 1인 개발자 운영

**가정:**
1명의 개발자가 장기 운영한다고 가정합니다.

**영향:**
- 과도한 추상화 지양
- 문서화 중요도 높음
- 복잡도 최소화

**대응:**
- 실용적 Hexagonal Architecture 선택
- 상세한 문서 작성
- 단순하지만 확장 가능한 구조

---

## 우선순위

### Phase 1: MVP (1-2개월)

**필수 기능:**
- [x] FR-001: 예약 정보 수신 및 저장
- [x] FR-002: 예약 확정 (블랙리스트 체크 포함)
- [x] FR-003: 예약 상세 조회
- [x] FR-004: 예약 목록 조회
- [x] FR-006: 블랙리스트 등록
- [x] FR-007: 블랙리스트 조회

**목표:**
- 기본 예약 관리 기능 동작
- 블랙리스트 자동 거절 동작

---

### Phase 2: 확장 (3-4개월)

**추가 기능:**
- [ ] FR-005: 추가 정보 업데이트
- [ ] FR-008: 블랙리스트 해제
- [ ] FR-009: 일별 예약 현황
- [ ] FR-010: 월별 예약 현황

**목표:**
- 사용자 편의 기능 추가
- 기본 통계 제공

---

### Phase 3: 고도화 (5-6개월)

**고급 기능:**
- [ ] FR-011: 예약률/공실률
- [ ] 가격 Breakdown (시간/상품 분리 저장)
- [ ] 시스템 자동 블랙리스트 등록 (노쇼 패턴)
- [ ] 이벤트 멱등성 강화 (Outbox Pattern)

**목표:**
- 고급 분석 기능
- 운영 안정성 향상

---

### Phase 4: 분리 (6개월 이후)

**아키텍처 진화:**
- [ ] 통계 서버 분리 (CQRS)
- [ ] 캐싱 도입 (Redis)
- [ ] 모니터링 강화 (Grafana, Prometheus)

**목표:**
- 대규모 트래픽 대응
- 서비스 독립성 강화

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-01-12 | 초기 요구사항 작성 | DDing Joo |

---

## 승인

| 역할 | 이름 | 승인 날짜 | 서명 |
|------|------|-----------|------|
| Develop Team Lead | DDing Joo | 2025-01-12 | - |

---

Last Updated: 2025-01-12