name: Release Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '21'
  DOCKER_IMAGE_NAME: ddingsh9/mzc-core-api

jobs:
  # ===========================================
  # Validate Release
  # ===========================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # Check if it's a prerelease (contains -alpha, -beta, -rc, etc.)
            if [[ "$VERSION" =~ -(alpha|beta|rc|dev) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}, Prerelease: ${IS_PRERELEASE}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Error: Invalid version format. Expected: v{major}.{minor}.{patch}[-prerelease]"
            exit 1
          fi
          echo "Version format is valid: ${VERSION}"

  # ===========================================
  # Build Release Artifacts
  # ===========================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ./springboot

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: lms_test_db
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test --no-daemon

      - name: Run full test suite
        env:
          SPRING_PROFILES_ACTIVE: test
          DATABASE_URL: localhost
          DATABASE_PORT: 3306
          DATABASE_NAME: lms_test_db
          DATABASE_USER: testuser
          DATABASE_PASSWORD: testpassword
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-jwt-secret-key-for-testing-purposes-only-32chars
          JWT_ACCESS_TOKEN_EXPIRATION_TIME: 3600000
          JWT_REFRESH_TOKEN_EXPIRATION_TIME: 604800000
          ENCRYPTION_KEY: test-encryption-key-32characters!
          ENCRYPTION_IV: test-iv-16chars!
        run: ./gradlew test --no-daemon

      - name: Run code quality checks
        run: ./gradlew codeQuality --no-daemon
        continue-on-error: true

      - name: Rename JAR with version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NUM="${VERSION#v}"
          mv build/libs/*.jar build/libs/lms-backend-${VERSION_NUM}.jar
          ls -la build/libs/

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            springboot/build/libs/*.jar
            springboot/build/reports/
          retention-days: 30

  # ===========================================
  # Build & Push Docker Image
  # ===========================================
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [ validate, build ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version number
        id: version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NUM="${VERSION#v}"
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.validate.outputs.version }}
            ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.version_num }}
            ${{ env.DOCKER_IMAGE_NAME }}:release
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_VERSION=${{ needs.validate.outputs.version }}

  # ===========================================
  # Create GitHub Release
  # ===========================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [ validate, build, docker ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: artifacts

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [[ -n "$PREV_TAG" ]]; then
            echo "Generating changelog from ${PREV_TAG} to HEAD"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tag found, using all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          echo "changelog_file=changelog.txt" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body: |
            ## MZC LMS Backend ${{ needs.validate.outputs.version }}

            ### Docker Image
            ```bash
            docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.validate.outputs.version }}
            ```

            ### Changes
            ${{ steps.changelog.outputs.changelog_file && '$(cat changelog.txt)' || 'See commit history for changes.' }}

            ### Artifacts
            - JAR file included in release assets
            - Docker image available on Docker Hub

            ---
            *Released by GitHub Actions*
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            artifacts/**/*.jar
          generate_release_notes: true

  # ===========================================
  # Notify Release
  # ===========================================
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [ validate, release ]
    if: success()

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ New Release: ${{ needs.validate.outputs.version }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "A new version of MZC LMS Backend has been released!"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ needs.validate.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Type:*\n${{ needs.validate.outputs.is_prerelease == 'true' && 'Pre-release' || 'Stable' }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Docker Hub"
                      },
                      "url": "https://hub.docker.com/r/ddingsh9/mzc-core-api"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK